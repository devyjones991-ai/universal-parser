# Universal Parser

Универсальный парсер и Telegram-бот, разделённый на тематические пакеты и оснащённый очередью задач, конфигурационным слоем и миграциями Alembic.

## Структура проекта

```
.
├── analytics/          # Парсеры и аналитика
├── alerts/             # Механизмы уведомлений
├── bot/                # Telegram-бот и его команды
├── core/               # Общие компоненты: настройки, логирование, БД, очередь
├── integrations/       # Внешние интеграции
├── profiles/           # Профили парсинга и их загрузчик
├── alembic/            # Скрипты миграций БД
├── main.py             # Точка входа приложения
└── tests/              # Автотесты
```

Ключевые компоненты:
- `core.config` — централизованная конфигурация (бот, база, очередь, планировщик, внешние API).
- `core.tasks` — in-memory очередь длительных задач с маршрутизацией.
- `core.database` + `alembic` — модели и миграции базы данных.
- `analytics.parser` — универсальный парсер с поддержкой HTML, API и динамических страниц.
- `bot` — Telegram-бот, использующий очередь задач для тяжёлых операций.

## Установка зависимостей

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
# Для Playwright (если используется динамический парсинг)
python -m playwright install
```

## Конфигурация

Настройки описаны в `core/config.py` и могут переопределяться через переменные окружения (`.env`). Основные параметры:

| Переменная | Назначение |
|------------|------------|
| `TELEGRAM_BOT_TOKEN` | Токен Telegram-бота |
| `TELEGRAM_CHAT_ID` | Основной чат для доступа |
| `ADMIN_CHAT_IDS` | Дополнительные администраторы (через запятую) |
| `STORAGE__DATABASE_URL` | URL базы данных |
| `QUEUE__ENABLED` | Включение очереди задач |
| `QUEUE__CONCURRENCY` | Количество воркеров очереди |
| `SCHEDULER__ENABLED` | Включение планировщика |
| `EXTERNAL_API__BASE_URL` | Базовый URL внешнего API |

Путь к профилям парсинга задаётся параметром `profiles_path`. По умолчанию используется `profiles/parsing_profiles.json`.

## Миграции Alembic

Миграции располагаются в каталоге `alembic/versions`. Для работы используется конфигурация `alembic.ini`.

1. **Применение всех миграций**:
   ```bash
   alembic upgrade head
   ```
2. **Создание новой миграции**:
   ```bash
   alembic revision -m "описание"
   ```
3. **Откат миграций**:
   ```bash
   alembic downgrade -1
   ```

Alembic использует URL из `STORAGE__DATABASE_URL`, поэтому убедитесь, что переменная настроена.

## Очередь задач

Очередь реализована в `core/tasks.py`. Длительные операции (парсинг URL и профилей) выполняются через зарегистрированные маршруты:
- `parse_url` — обрабатывает команду `/parse`.
- `run_profile` — запускает профиль парсинга из `/run`.

Очередь поддерживает асинхронных воркеров, количество которых задаётся настройкой `QUEUE__CONCURRENCY`. При выключенной очереди (`QUEUE__ENABLED=false`) задачи выполняются сразу в обработчике.

## Запуск Telegram-бота

```bash
python main.py
```

Бот автоматически настраивает логирование и запускает очередь задач при старте. Команды доступны только администраторам.

## Тестирование

```bash
pytest
```

Тесты покрывают маршрутизацию очереди задач и обеспечивают корректную обработку зарегистрированных и неизвестных маршрутов.
